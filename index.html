<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="theme-color" content="#1f7a3a" />
<title>é¦¬å¹´çƒé“è¡åˆºï½œGreen Run</title>
<style>
  :root{
    --bg:#eaf7ef;
    --ink:#0b2b16;
    --muted: rgba(11,43,22,.62);
    --line: rgba(11,43,22,.12);

    --card: rgba(255,255,255,.84);
    --card2: rgba(255,255,255,.94);

    --green:#1f7a3a;
    --green2:#2ea954;
    --red:#e94b5a;
    --gold:#d3b24a;
    --water:#42a5f5;
    --sand:#f2d38d;

    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
  }

  *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
  html,body{ height:100%; margin:0; background:var(--bg); font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC","Noto Sans TC", Arial; color:var(--ink); overflow:hidden; }

  #app{
    height:100%;
    max-width: 740px;
    margin: 0 auto;
    padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bottom));
    display:grid;
    grid-template-rows:auto 1fr auto;
    gap: 10px;
  }

  header, footer{
    border: 1px solid var(--line);
    border-radius: 18px;
    background: linear-gradient(180deg, var(--card2), var(--card));
    backdrop-filter: blur(10px);
    box-shadow: 0 12px 30px rgba(0,0,0,.06);
    padding: 10px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }

  .brand{
    display:flex; flex-direction:column; gap:2px; min-width: 180px;
  }
  .brand .t{
    display:flex; align-items:baseline; gap:8px;
    font-weight: 900;
    letter-spacing:.2px;
    font-size: 15px;
  }
  .brand .tag{
    font-size: 12px;
    color: var(--muted);
    line-height: 1.2;
  }

  .hud{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
  .pill{
    background: rgba(255,255,255,.80);
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 7px 10px;
    font-size: 12px;
    color: var(--muted);
    display:flex; align-items:baseline; gap:6px;
    min-width: 98px;
    justify-content:space-between;
  }
  .pill b{ color: var(--ink); font-weight: 900; }
  .pill .u{ opacity:.75; font-size: 11px; }

  main{
    position:relative;
    border-radius: 20px;
    overflow:hidden;
    border: 1px solid var(--line);
    background: #f7fffa;
    box-shadow: 0 18px 45px rgba(0,0,0,.08);
  }
  canvas{ width:100%; height:100%; display:block; }

  .overlay{
    position:absolute; inset:0;
    display:flex;
    align-items:flex-end;
    justify-content:center;
    padding: 16px;
    background:
      radial-gradient(1000px 700px at 50% 30%, rgba(255,255,255,.92) 0%, rgba(234,247,239,.82) 42%, rgba(234,247,239,.62) 100%);
  }

  .card{
    width: min(560px, 100%);
    border-radius: 20px;
    border: 1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,255,255,.82));
    box-shadow: 0 22px 60px rgba(0,0,0,.10);
    padding: 14px 14px;
  }
  .card h1{ margin:0; font-size: 18px; letter-spacing:.2px; }
  .card p{ margin: 8px 0; color: var(--muted); font-size: 13px; line-height: 1.55; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }

  button{
    cursor:pointer;
    user-select:none;
    border-radius: 14px;
    padding: 10px 12px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,.92);
    color: var(--ink);
    font-weight: 850;
    letter-spacing:.2px;
  }
  button.primary{
    background: linear-gradient(180deg, rgba(31,122,58,.98), rgba(46,169,84,.92));
    color: white;
    border-color: rgba(31,122,58,.25);
  }
  button.ghost{
    background: transparent;
  }
  button:active{ transform: translateY(1px); }

  .hint{ font-size: 12px; color: var(--muted); line-height: 1.45; }
  .hint code{ background: rgba(11,43,22,.06); border: 1px solid rgba(11,43,22,.10); padding: 1px 6px; border-radius: 999px; color: var(--ink); }

  footer{ justify-content:space-between; }
  .footerLeft{ display:flex; flex-direction:column; gap:4px; }
  .footerBtns{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

  .toast{
    position:absolute; left:50%; bottom: 14px;
    transform: translateX(-50%);
    background: rgba(11,43,22,.88);
    color: rgba(255,255,255,.96);
    border: 1px solid rgba(255,255,255,.24);
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 13px;
    opacity:0; pointer-events:none;
    transition: opacity .18s ease, transform .18s ease;
    box-shadow: 0 18px 50px rgba(0,0,0,.18);
  }
  .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }

  /* End screen */
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top: 10px; }
  .stat{
    border: 1px solid var(--line);
    background: rgba(255,255,255,.82);
    border-radius: 14px;
    padding: 10px 12px;
  }
  .stat .k{ font-size: 12px; color: var(--muted); }
  .stat .v{ font-size: 18px; font-weight: 920; margin-top: 2px; }

  .field{ margin-top: 10px; }
  .field label{ font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
  input, textarea{
    width: 100%;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,.92);
    padding: 10px 12px;
    font-size: 14px;
    color: var(--ink);
    outline: none;
  }
  textarea{ resize:none; min-height: 46px; }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
  .chip{
    border:1px solid var(--line);
    background: rgba(255,255,255,.86);
    border-radius: 999px;
    padding: 7px 10px;
    font-size: 12px;
    color: var(--muted);
    cursor:pointer;
    user-select:none;
  }
  .chip:hover{ border-color: rgba(11,43,22,.18); }
  .chip:active{ transform: translateY(1px); }

  .cardFooterBlessing{
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed rgba(11,43,22,.18);
    color: rgba(11,43,22,.92);
    line-height: 1.55;
  }
  .cardFooterBlessing .company{ color: var(--muted); font-size: 12px; margin-top: 6px; }

  @media (max-width: 420px){
    header{ padding: 10px 10px; }
    .pill{ min-width: 92px; padding: 7px 9px; }
    .grid2{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">
      <div class="t">â›³ é¦¬å¹´çƒé“è¡åˆº <span style="font-weight:800;color:var(--muted);font-size:12px;">60s</span></div>
      <div class="tag">æ‹–æ›³å·¦å³æ¨çƒï¼ˆç„¡æ®µå¼ï¼‰ï½œç´…åŒ…ã€çƒæ——åŠ åˆ†ï½œæ’éšœç¤™ä¸æœƒçµæŸä½†æœƒæ‰£åˆ†/é™é€Ÿ</div>
    </div>
    <div class="hud">
      <div class="pill">Distance <b id="uiDist">0</b><span class="u">m</span></div>
      <div class="pill">Score <b id="uiScore">0</b></div>
      <div class="pill">Time <b id="uiTime">60.0</b><span class="u">s</span></div>
    </div>
  </header>

  <main>
    <canvas id="c" aria-label="Golf runner canvas"></canvas>
    <div class="toast" id="toast">å·²è¤‡è£½åˆ†äº«æ–‡å­— âœ…</div>

    <div class="overlay" id="startOverlay">
      <div class="card">
        <h1>é¦¬å¹´é–‹çƒï¼Œå¾€å‰è¡</h1>
        <p>å…ˆçœ‹ 2 ç§’ã€Œæ“Šçƒé–‹å ´ã€ï¼Œæ¥è‘—ä½ è¦æ§åˆ¶çƒåœ¨çƒé“ä¸Šè¡åˆº 60 ç§’ã€‚<br>
        <strong>ç´…åŒ…</strong>é€£åƒæœƒæœ‰é€£æ“ŠåŠ æˆï¼›<strong>çƒæ——</strong>æ˜¯é«˜åˆ†ç¨€æœ‰é“å…·ã€‚</p>
        <div class="row">
          <button class="primary" id="btnStart">â–¶ é–‹å§‹</button>
          <button class="ghost" id="btnHow">æ“ä½œæç¤º</button>
        </div>
        <p class="hint">æ‰‹æ„Ÿï¼šåéˆæ•ï¼ˆAï¼‰ï½œç”¨æ‹‡æŒ‡åœ¨ç•«é¢ä¸‹åŠéƒ¨å·¦å³æ‹–æ›³ã€‚</p>
      </div>
    </div>

    <div class="overlay" id="endOverlay" style="display:none;">
      <div class="card">
        <h1>å®Œæˆ 60 ç§’</h1>
        <p style="margin-top:6px;">ç•™ä¸‹æˆç¸¾ï¼ˆFirebase ç‰ˆæœƒä¸Šå‚³åˆ° Top 100 æ’è¡Œæ¦œï¼‰</p>

        <div class="grid2">
          <div class="stat"><div class="k">Final Score</div><div class="v" id="endScore">0</div></div>
          <div class="stat"><div class="k">Distance</div><div class="v"><span id="endDist">0</span> m</div></div>
        </div>

        <div class="field">
          <label>æš±ç¨±ï¼ˆ8 å­—å…§ï¼‰</label>
          <input id="inpName" maxlength="8" placeholder="ä¾‹å¦‚ï¼šé˜¿å‡±">
        </div>

        <div class="field">
          <label>ç¥ç¦èªï¼ˆå¿…å¡«ï¼Œ18 å­—å…§ï¼‰</label>
          <textarea id="inpBless" maxlength="18" placeholder="ä¾‹å¦‚ï¼šæ­¥ä¼ä¸æ€¥ï¼Œæ–¹å‘æ­£ç¢º"></textarea>
          <div class="chips" id="chipRow">
            <div class="chip">æ…¢æ…¢è·‘ï¼Œä¹Ÿæœƒè·‘å¾—é </div>
            <div class="chip">ç©©ç©©å‘å‰ï¼Œå¥½äº‹ç™¼ç”Ÿ</div>
            <div class="chip">ä¸€è·¯é–‹çƒï¼Œä¸€è·¯é †å¿ƒ</div>
            <div class="chip">é¦¬å¹´é †è¡Œï¼Œå¤©å¤©å¥½çƒ</div>
            <div class="chip">æ­¥ä¼ä¸æ€¥ï¼Œæ–¹å‘æ­£ç¢º</div>
          </div>
        </div>

        <div class="row">
          <button class="primary" id="btnRestart">â†» å†è·‘ä¸€æ¬¡</button>
          <button class="ghost" id="btnShare">ğŸ“¤ åˆ†äº«æˆç¸¾</button>
        </div>

        <div class="cardFooterBlessing">
          <div>é¡˜æ‚¨é€™ä¸€å¹´<br>æ­¥ä¼ä¸æ€¥ï¼Œæ–¹å‘æ­£ç¢º</div>
          <div class="company">â€” å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸</div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <div class="footerLeft">
      <div class="hint">ç©æ³•ï¼šæ‹–æ›³å·¦å³æ¨çƒï¼ˆç„¡æ®µå¼ï¼‰ï½œé¬†æ‰‹å›æ­£ï½œå¯æŒ‰ <code>R</code> é‡é–‹</div>
      <div class="hint">éšœç¤™ï¼šæ²™å‘=é™é€Ÿï½œæ¨¹å¢=å½ˆé£›ï½œæ°´æ± =é‡ç½°ï¼ˆä¸çµæŸï¼‰</div>
    </div>
    <div class="footerBtns">
      <button class="ghost" id="btnPause">â¸ æš«åœ</button>
      <button class="ghost" id="btnReset">ğŸ§¹ é‡ç½®</button>
    </div>
  </footer>
</div>

<script>
(() => {
  const CFG = {
    duration: 60.0,
    v0: 8.2, vMax: 18.8, accelTime: 42.0,

    // Aï¼šéˆæ•
    lateralMax: 1.0,
    lateralAccel: 18.0,
    lateralDamp: 13.5,
    returnForce: 6.0,

    viewDist: 74,
    spawnEvery: 0.54,
    spawnJitter: 0.26,

    collideZ: 2.4,

    scorePerMeter: 5,
    giftScore: 260,
    flagScore: 920,
    comboWindow: 1.2,
    comboMax: 6,

    sandSlowMul: 0.55,
    sandSlowTime: 1.0,
    waterSlowMul: 0.38,
    waterSlowTime: 1.45,
    bushPush: 0.9,
    scoreHitPenalty: 190,
  };

  // DOM
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: false });
  ctx.imageSmoothingEnabled = true;

  const uiDist = document.getElementById('uiDist');
  const uiScore = document.getElementById('uiScore');
  const uiTime = document.getElementById('uiTime');

  const startOverlay = document.getElementById('startOverlay');
  const endOverlay = document.getElementById('endOverlay');
  const endScore = document.getElementById('endScore');
  const endDist = document.getElementById('endDist');

  const btnStart = document.getElementById('btnStart');
  const btnHow = document.getElementById('btnHow');
  const btnPause = document.getElementById('btnPause');
  const btnReset = document.getElementById('btnReset');
  const btnRestart = document.getElementById('btnRestart');
  const btnShare = document.getElementById('btnShare');

  const inpName = document.getElementById('inpName');
  const inpBless = document.getElementById('inpBless');
  const chipRow = document.getElementById('chipRow');
  const toast = document.getElementById('toast');

  // chips
  chipRow.addEventListener('click', (e)=>{
    const t = e.target;
    if (t && t.classList.contains('chip')){
      inpBless.value = t.textContent.trim();
      showToast('å·²å¡«å…¥ç¥ç¦èª âœ¨');
    }
  });

  // helpers
  const clamp = (v,a,b)=>Math.max(a, Math.min(b,v));
  const lerp = (a,b,t)=>a+(b-a)*t;
  const rand = (a,b)=>a+Math.random()*(b-a);

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), 1100);
  }

  // resize
  let W=360,H=640,DPR=1;
  function resize(){
    const r = canvas.getBoundingClientRect();
    DPR = Math.min(2, window.devicePixelRatio || 1);
    canvas.width = Math.floor(r.width * DPR);
    canvas.height = Math.floor(r.height * DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
    W = r.width; H = r.height;
  }
  new ResizeObserver(resize).observe(canvas);
  window.addEventListener('resize', ()=>setTimeout(resize, 60));
  window.addEventListener('orientationchange', ()=>setTimeout(resize, 140));

  // state
  let running=false, paused=false;
  let tLeft=CFG.duration;
  let score=0, dist=0, v=CFG.v0;
  let slowMul=1, slowT=0;

  // lateral (continuous)
  let x=0, vxLat=0;
  let dragging=false, dragPrevX=0, dragPointerId=null;

  // entities
  let entities=[];
  let spawnTimer=0;

  // combo
  let combo=1, bestCombo=1, lastGiftTime=-999;

  // mode
  let mode='start'; // start | swing | run | end
  let swingT=0;

  // input
  function pointerDown(ev){
    dragging = true;
    dragPrevX = ev.clientX;
    dragPointerId = ev.pointerId ?? null;
    try{ canvas.setPointerCapture?.(ev.pointerId); }catch(_){}
  }
  function pointerMove(ev){
    if (!dragging) return;
    if (dragPointerId != null && ev.pointerId != null && ev.pointerId !== dragPointerId) return;
    const dx = (ev.clientX - dragPrevX) / Math.max(220, W*0.6);
    vxLat += dx * CFG.lateralAccel * 3.2;
    dragPrevX = ev.clientX;
  }
  function pointerUp(ev){
    if (dragPointerId != null && ev.pointerId != null && ev.pointerId !== dragPointerId) return;
    dragging = false;
    dragPointerId = null;
  }
  canvas.addEventListener('pointerdown', pointerDown, {passive:true});
  window.addEventListener('pointermove', pointerMove, {passive:true});
  window.addEventListener('pointerup', pointerUp, {passive:true});
  window.addEventListener('pointercancel', pointerUp, {passive:true});

  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if (k === 'r'){ resetAll(); startOverlay.style.display='flex'; endOverlay.style.display='none'; mode='start'; }
    if (k === ' '){ togglePause(); e.preventDefault(); }
  }, {passive:false});

  function updateUI(){
    uiDist.textContent = String(Math.floor(dist));
    uiScore.textContent = String(Math.max(0, Math.floor(score)));
    uiTime.textContent = tLeft.toFixed(1);
    btnPause.textContent = paused ? 'â–¶ ç¹¼çºŒ' : 'â¸ æš«åœ';
  }

  // projection (isometric-lite)
  function proj(zAhead){
    const yFar = H*0.12;
    const yNear = H*0.86;
    const t = clamp(zAhead / CFG.viewDist, 0, 1);
    const y = lerp(yNear, yFar, t);
    const wNear = W*0.92;
    const wFar  = W*0.30;
    const w = lerp(wNear, wFar, t);
    return { y, w, t };
  }
  function xToScreen(xNorm, zAhead){
    const p = proj(zAhead);
    return (W*0.5) + xNorm * (p.w * 0.5);
  }

  // drawing (cleaner flat style)
  function drawSky(scroll){
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0, '#dff6ff');
    g.addColorStop(0.40, '#eaf7ef');
    g.addColorStop(1, '#f7fffb');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    // soft clouds
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = '#ffffff';
    const cx = (scroll*0.20) % (W*0.9);
    for(let i=-2;i<4;i++){
      const x0 = i*(W*0.9) - cx;
      const y0 = H*0.12 + (i%2)*10;
      ctx.beginPath();
      ctx.ellipse(x0 + 80, y0 + 10, 60, 18, 0, 0, Math.PI*2);
      ctx.ellipse(x0 + 130, y0 + 14, 70, 22, 0, 0, Math.PI*2);
      ctx.ellipse(x0 + 190, y0 + 10, 60, 18, 0, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // distant hills
    ctx.globalAlpha = 0.55;
    ctx.fillStyle = '#bfead0';
    ctx.beginPath();
    ctx.moveTo(0, H*0.26);
    ctx.quadraticCurveTo(W*0.18, H*0.18, W*0.36, H*0.25);
    ctx.quadraticCurveTo(W*0.55, H*0.33, W*0.70, H*0.24);
    ctx.quadraticCurveTo(W*0.86, H*0.15, W, H*0.22);
    ctx.lineTo(W,0); ctx.lineTo(0,0); ctx.closePath();
    ctx.fill();
    ctx.globalAlpha = 1;

    // tree line parallax
    ctx.globalAlpha = 0.16;
    ctx.fillStyle = '#1f7a3a';
    const baseY = H*0.27;
    const shift = (scroll*0.18) % (W*0.22);
    for(let i=-2;i<10;i++){
      const tx = i*(W*0.22) - shift;
      ctx.beginPath();
      ctx.ellipse(tx+20, baseY+10, 26, 12, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath();
      ctx.ellipse(tx+45, baseY+14, 18, 9, 0, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;
  }

  function drawCourse(scroll){
    // rough
    ctx.fillStyle = '#cfeeda';
    ctx.fillRect(0,0,W,H);

    // fairway trapezoid
    const pFar = proj(CFG.viewDist);
    const pNear = proj(0);
    const cx = W*0.5;

    const farL = cx - pFar.w*0.5, farR = cx + pFar.w*0.5;
    const nearL = cx - pNear.w*0.5, nearR = cx + pNear.w*0.5;

    // fairway gradient
    const fwG = ctx.createLinearGradient(0, pFar.y, 0, pNear.y);
    fwG.addColorStop(0, '#58c972');
    fwG.addColorStop(1, '#39aa57');
    ctx.fillStyle = fwG;
    ctx.beginPath();
    ctx.moveTo(farL, pFar.y);
    ctx.lineTo(farR, pFar.y);
    ctx.lineTo(nearR, pNear.y);
    ctx.lineTo(nearL, pNear.y);
    ctx.closePath();
    ctx.fill();

    // stripes (less noisy)
    const stripeCount = 10;
    const phase = (scroll*0.06) % 1;
    for(let i=0;i<stripeCount;i++){
      const t0 = (i/stripeCount);
      const t1 = ((i+1)/stripeCount);

      const tz0 = ((t0 + phase) % 1) * CFG.viewDist;
      const tz1 = ((t1 + phase) % 1) * CFG.viewDist;

      const a = proj(tz0), b = proj(tz1);
      const xa1 = cx - a.w*0.5, xa2 = cx + a.w*0.5;
      const xb1 = cx - b.w*0.5, xb2 = cx + b.w*0.5;

      ctx.globalAlpha = (i%2===0) ? 0.10 : 0.04;
      ctx.fillStyle = '#0b2b16';
      ctx.beginPath();
      ctx.moveTo(xa1, a.y);
      ctx.lineTo(xa2, a.y);
      ctx.lineTo(xb2, b.y);
      ctx.lineTo(xb1, b.y);
      ctx.closePath();
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // center line & edges
    ctx.strokeStyle = 'rgba(255,255,255,0.28)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(cx, pFar.y);
    ctx.lineTo(cx, pNear.y);
    ctx.stroke();

    ctx.globalAlpha = 0.30;
    ctx.strokeStyle = 'rgba(255,255,255,0.24)';
    ctx.beginPath(); ctx.moveTo(farL, pFar.y); ctx.lineTo(nearL, pNear.y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(farR, pFar.y); ctx.lineTo(nearR, pNear.y); ctx.stroke();
    ctx.globalAlpha = 1;
  }

  function drawSpeedStreaks(){
    // subtle streaks near bottom when speed high
    const sr = clamp(v/CFG.vMax, 0, 1);
    if (sr < 0.55) return;
    const n = Math.floor(lerp(0, 14, (sr-0.55)/0.45));
    ctx.globalAlpha = 0.10 + (sr-0.55)*0.18;
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 2;
    for(let i=0;i<n;i++){
      const x0 = rand(0, W);
      const y0 = rand(H*0.55, H*0.92);
      const len = rand(20, 70) * sr;
      ctx.beginPath();
      ctx.moveTo(x0, y0);
      ctx.lineTo(x0, y0 + len);
      ctx.stroke();
    }
    ctx.globalAlpha = 1;
  }

  function drawBall(){
    const py = proj(0).y;
    const px = xToScreen(x, 0);
    const sr = clamp(v/CFG.vMax, 0, 1);

    // shadow
    ctx.globalAlpha = 0.16 + sr*0.12;
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.ellipse(px+6, py+18, 18 + sr*10, 7 + sr*2, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // outline
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'rgba(11,43,22,.15)';

    // body
    const r = 14;
    const ballG = ctx.createRadialGradient(px-6, py-8, 2, px, py, 18);
    ballG.addColorStop(0, '#ffffff');
    ballG.addColorStop(0.55, '#eef2f5');
    ballG.addColorStop(1, '#cbd3da');
    ctx.fillStyle = ballG;
    ctx.beginPath();
    ctx.arc(px, py, r, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();

    // dimples
    ctx.globalAlpha = 0.09;
    ctx.fillStyle = '#7a8792';
    for(let i=0;i<12;i++){
      const a = i*0.52 + (dist*0.11);
      ctx.beginPath();
      ctx.arc(px + Math.cos(a)*8, py + Math.sin(a)*6, 1.1, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    // highlight
    ctx.globalAlpha = 0.70;
    ctx.fillStyle = 'rgba(255,255,255,0.92)';
    ctx.beginPath();
    ctx.ellipse(px-5, py-7, 6, 4, -0.5, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }

  function drawEntity(e){
    const p = proj(e.z);
    const px = xToScreen(e.x, e.z);
    const py = p.y;
    const scale = lerp(1.10, 0.50, clamp(e.z/CFG.viewDist,0,1));

    if (e.type === 'gift'){
      ctx.save();
      ctx.translate(px, py);
      ctx.scale(scale, scale);
      ctx.rotate(Math.sin((performance.now()/220)+e.w)*0.10);

      // card base
      ctx.fillStyle = '#e94b5a';
      ctx.strokeStyle = 'rgba(11,43,22,.18)';
      ctx.lineWidth = 2;
      rr(-14, -10, 28, 20, 6);
      ctx.fill(); ctx.stroke();

      // fold
      ctx.fillStyle = 'rgba(255,255,255,.32)';
      ctx.beginPath();
      ctx.moveTo(-14, -10);
      ctx.lineTo(0, 0);
      ctx.lineTo(14, -10);
      ctx.closePath();
      ctx.fill();

      // seal
      ctx.fillStyle = '#d3b24a';
      ctx.beginPath();
      ctx.arc(0, 4, 3.2, 0, Math.PI*2);
      ctx.fill();

      ctx.restore();
      return;
    }

    if (e.type === 'flag'){
      ctx.save();
      ctx.translate(px, py);
      ctx.scale(scale, scale);

      ctx.strokeStyle = 'rgba(11,43,22,.62)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(0, 14);
      ctx.lineTo(0, -14);
      ctx.stroke();

      ctx.fillStyle = '#ffffff';
      ctx.globalAlpha = 0.96;
      ctx.beginPath();
      ctx.moveTo(0, -14);
      ctx.lineTo(16, -10);
      ctx.lineTo(0, -6);
      ctx.closePath();
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.fillStyle = '#d3b24a';
      ctx.beginPath();
      ctx.arc(0, 14, 6, 0, Math.PI*2);
      ctx.fill();

      ctx.restore();
      return;
    }

    if (e.type === 'sand'){
      ctx.save();
      ctx.translate(px, py);
      ctx.scale(scale, scale);

      ctx.fillStyle = '#f2d38d';
      ctx.strokeStyle = 'rgba(11,43,22,.18)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.ellipse(0, 8, 26, 14, -0.2, 0, Math.PI*2);
      ctx.fill(); ctx.stroke();

      ctx.globalAlpha = 0.16;
      ctx.fillStyle = '#0b2b16';
      for(let i=0;i<5;i++){
        ctx.beginPath();
        ctx.ellipse(rand(-12,12), rand(3,14), rand(3,6), rand(1.2,3.0), rand(-0.6,0.6), 0, Math.PI*2);
        ctx.fill();
      }
      ctx.restore();
      ctx.globalAlpha = 1;
      return;
    }

    if (e.type === 'water'){
      ctx.save();
      ctx.translate(px, py);
      ctx.scale(scale, scale);

      ctx.fillStyle = '#42a5f5';
      ctx.strokeStyle = 'rgba(11,43,22,.18)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(-30, 2);
      ctx.quadraticCurveTo(-14, -14, 8, -10);
      ctx.quadraticCurveTo(26, -6, 32, 10);
      ctx.quadraticCurveTo(8, 22, -18, 18);
      ctx.quadraticCurveTo(-30, 14, -30, 2);
      ctx.closePath();
      ctx.fill(); ctx.stroke();

      ctx.globalAlpha = 0.25;
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(-10, 4, 10, 0.2, 2.6);
      ctx.stroke();
      ctx.restore();
      ctx.globalAlpha = 1;
      return;
    }

    if (e.type === 'bush'){
      ctx.save();
      ctx.translate(px, py);
      ctx.scale(scale, scale);

      ctx.fillStyle = '#1f7a3a';
      ctx.strokeStyle = 'rgba(11,43,22,.22)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.ellipse(-12, 10, 14, 10, 0, 0, Math.PI*2);
      ctx.ellipse(  0,  6, 18, 13, 0, 0, Math.PI*2);
      ctx.ellipse( 14, 11, 13, 9, 0, 0, Math.PI*2);
      ctx.fill(); ctx.stroke();

      ctx.globalAlpha = 0.14;
      ctx.fillStyle = '#0b2b16';
      ctx.beginPath();
      ctx.ellipse(2, 6, 10, 7, 0.2, 0, Math.PI*2);
      ctx.fill();
      ctx.restore();
      ctx.globalAlpha = 1;
      return;
    }

    function rr(x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
    }
  }

  function drawSwingScene(){
    // nicer tee box scene
    drawSky(dist);

    // ground
    ctx.fillStyle = '#cfeeda';
    ctx.fillRect(0, H*0.36, W, H*0.64);
    ctx.fillStyle = '#39aa57';
    ctx.fillRect(0, H*0.50, W, H*0.50);

    // tee pad
    ctx.fillStyle = '#58c972';
    ctx.strokeStyle = 'rgba(11,43,22,.14)';
    ctx.lineWidth = 2;
    rr(W*0.14, H*0.72, W*0.72, H*0.16, 18);
    ctx.fill(); ctx.stroke();

    // crowd (colored, not black)
    const crowdY = H*0.60;
    const wave = Math.sin(performance.now()/380)*2.0;
    for(let i=0;i<12;i++){
      const cx = W*0.08 + i*(W*0.07);
      const hue = 140 + (i%5)*10;
      ctx.globalAlpha = 0.70;
      ctx.fillStyle = `hsl(${hue} 28% 24%)`;
      ctx.beginPath(); ctx.ellipse(cx, crowdY + wave, 10, 8, 0, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(cx, crowdY + 18 + wave, 8, 12, 0.15, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha = 1;

    // golfer (simple flat character with accent)
    const gx = W*0.50, gy = H*0.76;
    ctx.save();
    ctx.translate(gx, gy);

    const t = clamp(swingT / 2.0, 0, 1);
    const ease = t<0.5 ? (t*t*2) : (1 - (1-t)*(1-t)*2);
    const angle = lerp(-1.35, 0.72, ease);

    // legs
    ctx.fillStyle = '#0b2b16';
    ctx.globalAlpha = 0.92;
    ctx.beginPath(); ctx.ellipse(-10, 44, 10, 18, 0.20, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse( 10, 44, 10, 18, -0.20, 0, Math.PI*2); ctx.fill();
    // body (shirt)
    ctx.fillStyle = '#ffffff';
    ctx.globalAlpha = 0.95;
    ctx.beginPath(); ctx.ellipse(0, 20, 14, 22, 0, 0, Math.PI*2); ctx.fill();
    // head
    ctx.fillStyle = '#f2d1b2';
    ctx.globalAlpha = 0.95;
    ctx.beginPath(); ctx.ellipse(0, 2, 10, 10, 0, 0, Math.PI*2); ctx.fill();
    // cap
    ctx.fillStyle = '#1f7a3a';
    ctx.globalAlpha = 0.95;
    ctx.beginPath(); ctx.ellipse(-2, -2, 10, 6, 0, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(10, 0, 8, 3, 0.2, 0, Math.PI*2); ctx.fill();

    // club
    ctx.globalAlpha = 0.88;
    ctx.strokeStyle = 'rgba(11,43,22,.80)';
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(0, 22);
    ctx.lineTo(Math.cos(angle)*60, Math.sin(angle)*60);
    ctx.stroke();
    ctx.globalAlpha = 1;

    ctx.restore();

    // ball launch
    const launch = clamp((swingT-1.05)/0.6, 0, 1);
    const bx = W*0.52 + launch*(W*0.10);
    const by = H*0.84 - launch*(H*0.22);

    const bg = ctx.createRadialGradient(bx-5, by-6, 2, bx, by, 14);
    bg.addColorStop(0,'#fff'); bg.addColorStop(0.6,'#eef2f5'); bg.addColorStop(1,'#cbd3da');
    ctx.fillStyle = bg;
    ctx.beginPath(); ctx.arc(bx, by, 10, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = 'rgba(11,43,22,.12)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // text
    ctx.fillStyle = 'rgba(11,43,22,.65)';
    ctx.font = '800 13px ui-sans-serif, system-ui';
    ctx.fillText('é–‹çƒä¸­â€¦', 14, 22);

    function rr(x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
    }
  }

  // spawning
  function spawn(){
    const z = CFG.viewDist - rand(4, 10);
    const xPos = rand(-0.95, 0.95);
    const r = Math.random();
    if (r < 0.42) entities.push({type:'gift', z, x:xPos, w: rand(0.6, 1.4)});
    else if (r < 0.48) entities.push({type:'flag', z, x:xPos});
    else if (r < 0.70) entities.push({type:'sand', z, x:xPos});
    else if (r < 0.88) entities.push({type:'bush', z, x:xPos});
    else entities.push({type:'water', z, x:xPos});
  }

  function applyGift(now){
    if (now - lastGiftTime <= CFG.comboWindow) combo = Math.min(CFG.comboMax, combo+1);
    else combo = 1;
    bestCombo = Math.max(bestCombo, combo);
    lastGiftTime = now;
  }

  // collisions
  function hitTest(e){
    if (e.z > CFG.collideZ) return false;
    const base = 0.12;
    const th = (e.type==='gift' || e.type==='flag') ? base : (e.type==='sand' ? 0.18 : (e.type==='water' ? 0.20 : 0.17));
    return Math.abs(x - e.x) <= th;
  }

  function onHitObstacle(type){
    score = Math.max(0, score - CFG.scoreHitPenalty);
    if (type === 'sand'){
      slowMul = Math.min(slowMul, CFG.sandSlowMul);
      slowT = Math.max(slowT, CFG.sandSlowTime);
    }else if (type === 'water'){
      slowMul = Math.min(slowMul, CFG.waterSlowMul);
      slowT = Math.max(slowT, CFG.waterSlowTime);
      combo = 1;
    }else if (type === 'bush'){
      vxLat += (Math.random()<0.5?-1:1) * CFG.bushPush;
      combo = 1;
    }
  }

  // loop
  let lastTs=0;
  let entitiesVisible = [];

  function drawFrame(){
    drawSky(dist);
    drawCourse(dist);

    // speed streaks add punch
    drawSpeedStreaks();

    entitiesVisible = entities.filter(e => e.z <= CFG.viewDist+5 && e.z >= -6);
    entitiesVisible.sort((a,b)=>b.z - a.z);
    for(const e of entitiesVisible){
      if (e.z >= 0) drawEntity(e);
    }

    if (mode === 'run') drawBall();

    // combo label
    if (mode === 'run' && combo > 1){
      ctx.save();
      ctx.globalAlpha = 0.92;
      ctx.fillStyle = 'rgba(11,43,22,.70)';
      ctx.font = '900 12px ui-sans-serif, system-ui';
      ctx.fillText(`Combo x${combo}`, 14, H-14);
      ctx.restore();
    }

    // pause overlay
    if (paused && running){
      ctx.save();
      ctx.globalAlpha = 0.35;
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,W,H);
      ctx.globalAlpha = 1;
      ctx.fillStyle = 'rgba(255,255,255,.95)';
      ctx.font = '950 22px ui-sans-serif, system-ui';
      ctx.fillText('æš«åœä¸­', W/2 - 40, H/2 - 8);
      ctx.fillStyle = 'rgba(255,255,255,.84)';
      ctx.font = '14px ui-sans-serif, system-ui';
      ctx.fillText('æŒ‰ã€Œæš«åœã€æˆ–ç©ºç™½éµç¹¼çºŒ', W/2 - 96, H/2 + 18);
      ctx.restore();
    }
  }

  function step(ts){
    if (!running) return;
    const dt = Math.min(0.033, (ts-lastTs)/1000 || 0);
    lastTs = ts;

    if (paused){
      drawFrame();
      requestAnimationFrame(step);
      return;
    }

    if (mode === 'swing'){
      swingT += dt;
      drawSwingScene();
      if (swingT >= 2.0){
        mode = 'run';
        dist = 0; tLeft = CFG.duration; score = 0;
        combo = 1; bestCombo = 1; lastGiftTime = -999;
        entities = []; spawnTimer = 0;
        x = 0; vxLat = 0;
      }
      requestAnimationFrame(step);
      return;
    }

    // run
    tLeft -= dt;
    if (tLeft <= 0){
      tLeft = 0;
      updateUI();
      drawFrame();
      endGame();
      return;
    }

    // speed curve
    const t = clamp((CFG.duration - tLeft)/CFG.accelTime, 0, 1);
    const ease = 1 - Math.pow(1-t, 2.2);
    const baseV = lerp(CFG.v0, CFG.vMax, ease);

    // slow effects
    if (slowT > 0){
      slowT -= dt;
      if (slowT <= 0){ slowT = 0; slowMul = 1; }
    }else{
      slowMul = lerp(slowMul, 1, dt*3.2);
    }
    v = baseV * slowMul;

    // forward & score
    dist += v * dt;
    score += (v * dt) * CFG.scorePerMeter;

    // combo decay
    const now = ts/1000;
    if (now - lastGiftTime > CFG.comboWindow) combo = 1;

    // lateral physics (sensitive)
    const axReturn = dragging ? 0 : (-x * CFG.returnForce);
    vxLat += axReturn * dt;
    vxLat *= Math.exp(-CFG.lateralDamp * dt);
    x += vxLat * dt;
    x = clamp(x, -CFG.lateralMax, CFG.lateralMax);

    // spawn
    spawnTimer -= dt;
    if (spawnTimer <= 0){
      spawn();
      spawnTimer = CFG.spawnEvery + rand(-CFG.spawnJitter, CFG.spawnJitter);
    }

    // move entities
    for(const e of entities) e.z -= v * dt;

    // collisions & cleanup
    for(let i=entities.length-1;i>=0;i--){
      const e = entities[i];
      if (e.z < -6){ entities.splice(i,1); continue; }
      if (hitTest(e)){
        if (e.type === 'gift'){
          entities.splice(i,1);
          applyGift(now);
          score += CFG.giftScore * combo;
        }else if (e.type === 'flag'){
          entities.splice(i,1);
          applyGift(now);
          score += CFG.flagScore * Math.max(1, Math.floor(combo/2)+1);
        }else{
          entities.splice(i,1);
          onHitObstacle(e.type);
        }
      }
    }

    updateUI();
    drawFrame();
    requestAnimationFrame(step);
  }

  // control
  function resetAll(){
    running=false; paused=false;
    tLeft=CFG.duration; score=0; dist=0; v=CFG.v0;
    slowMul=1; slowT=0;
    x=0; vxLat=0;
    entities=[]; spawnTimer=0;
    combo=1; bestCombo=1; lastGiftTime=-999;
    mode='start'; swingT=0;
    updateUI();
    drawSky(0); drawCourse(0);
  }

  function startGame(){
    startOverlay.style.display = 'none';
    endOverlay.style.display = 'none';
    running = true;
    paused = false;
    mode = 'swing';
    swingT = 0;
    lastTs = performance.now();
    requestAnimationFrame(step);
  }

  function endGame(){
    running = false;
    paused = false;
    mode = 'end';
    endScore.textContent = String(Math.max(0, Math.floor(score)));
    endDist.textContent = String(Math.floor(dist));
    endOverlay.style.display = 'flex';
  }

  function togglePause(){
    if (!running || mode !== 'run') return;
    paused = !paused;
    updateUI();
  }

  // share
  async function shareScore(){
    const name = (inpName.value || 'æˆ‘').trim();
    const bless = (inpBless.value || '').trim();
    const s = Math.max(0, Math.floor(score));
    const d = Math.floor(dist);

    const msg =
`â›³ é¦¬å¹´çƒé“è¡åˆºï¼ˆ60sï¼‰
${name}ï¼š${s} åˆ†ï½œ${d} m
ç¥ç¦ï¼š${bless}
â€” å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸`;

    try{
      await navigator.clipboard.writeText(msg);
      showToast('å·²è¤‡è£½åˆ†äº«æ–‡å­— âœ…');
    }catch(err){
      window.prompt('è¤‡è£½é€™æ®µæ–‡å­—åˆ†äº«ï¼š', msg);
    }
  }

  // UI bind
  btnStart.addEventListener('click', startGame);
  btnRestart.addEventListener('click', startGame);
  btnPause.addEventListener('click', togglePause);
  btnReset.addEventListener('click', ()=>{
    resetAll();
    startOverlay.style.display = 'flex';
    endOverlay.style.display = 'none';
  });
  btnHow.addEventListener('click', ()=>showToast('æç¤ºï¼šæ‹–æ›³=æ¨çƒï½œé¬†æ‰‹å›æ­£ï½œéšœç¤™ä¸çµæŸä½†æœƒé™é€Ÿ/æ‰£åˆ†'));
  btnShare.addEventListener('click', ()=>{
    const bless = (inpBless.value || '').trim();
    if (!bless){ showToast('ç¥ç¦èªå¿…å¡« ğŸ™'); inpBless.focus(); return; }
    shareScore();
  });

  inpBless.addEventListener('input', ()=>{
    if (inpBless.value.length > 18) inpBless.value = inpBless.value.slice(0,18);
  });
  inpName.addEventListener('input', ()=>{
    if (inpName.value.length > 8) inpName.value = inpName.value.slice(0,8);
  });

  // boot
  setTimeout(()=>{ resize(); resetAll(); }, 0);
})();
</script>
</body>
</html>
